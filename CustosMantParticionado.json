{
    "zabbix_export": {
        "version": "6.4",
        "template_groups": [
            {
                "uuid": "64413dab4154436f9473b042acaffd54",
                "name": "Custos"
            }
        ],
        "templates": [
            {
                "uuid": "33558c1f77c94b2e8e3fc6eb64231542",
                "template": "Control Particionado MySQL - ODBC Custos",
                "name": "Control Particionado MySQL - ODBC Custos",
                "description": "Controles de d\u00edas que quedan en las particiones de las tablas mediante consultas ODBC a la base.\nEjecuci\u00f3n del mantenimiento de particionado",
                "vendor": {
                    "name": "Custos Monitoring",
                    "version": "1.0.0"
                },
                "groups": [
                    {
                        "name": "Custos"
                    }
                ],
                "items": [
                    {
                        "uuid": "a90235e9a0ae47daa929e54761f18136",
                        "name": "Dias disponibles en history",
                        "type": "ODBC",
                        "key": "db.odbc.get[Dias que quedan para history,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}]",
                        "delay": "1d",
                        "params": "CALL partition_daysleft(\"{$CTRLPART.DB.NAME}\",\"history\")",
                        "username": "{$CTRLPART.DB.USER}",
                        "password": "{$CTRLPART.DB.PASSWORD}",
                        "description": "Cantidad de d\u00edas enteros disponibles para insertar en la tabla",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.[0].DaysLeft"
                                ]
                            },
                            {
                                "type": "REGEX",
                                "parameters": [
                                    "\\d+",
                                    "\\0"
                                ],
                                "error_handler": "CUSTOM_ERROR",
                                "error_handler_params": "La tabla no est\u00e1 particionada"
                            }
                        ],
                        "tags": [
                            {
                                "tag": "Application",
                                "value": "Control"
                            },
                            {
                                "tag": "Application",
                                "value": "Particionado"
                            }
                        ],
                        "triggers": [
                            {
                                "uuid": "6ed1c21ae355454aa3ca2d952d25ebfc",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:history}",
                                "name": "Cantidad de d\u00edas en history menores a {$CTRLPART.DIASLEFT.HIGH:history}",
                                "priority": "HIGH",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES"
                            },
                            {
                                "uuid": "5de61fff04cf44d0ab74d660c6ca6413",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.WARNING:history}",
                                "name": "Cantidad de d\u00edas en history menores a {$CTRLPART.DIASLEFT.WARNING:history}",
                                "priority": "WARNING",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES",
                                "dependencies": [
                                    {
                                        "name": "Cantidad de d\u00edas en history menores a {$CTRLPART.DIASLEFT.HIGH:history}",
                                        "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:history}"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "uuid": "5c7c2a382579442bada9f0136dd17bf3",
                        "name": "Dias disponibles en history_log",
                        "type": "ODBC",
                        "key": "db.odbc.get[Dias que quedan para history_log,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}]",
                        "delay": "1d",
                        "params": "CALL partition_daysleft(\"{$CTRLPART.DB.NAME}\",\"history_log\")",
                        "username": "{$CTRLPART.DB.USER}",
                        "password": "{$CTRLPART.DB.PASSWORD}",
                        "description": "Cantidad de d\u00edas enteros disponibles para insertar en la tabla",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.[0].DaysLeft"
                                ]
                            },
                            {
                                "type": "REGEX",
                                "parameters": [
                                    "\\d+",
                                    "\\0"
                                ],
                                "error_handler": "CUSTOM_ERROR",
                                "error_handler_params": "La tabla no est\u00e1 particionada"
                            }
                        ],
                        "tags": [
                            {
                                "tag": "Application",
                                "value": "Control"
                            },
                            {
                                "tag": "Application",
                                "value": "Particionado"
                            }
                        ],
                        "triggers": [
                            {
                                "uuid": "2227783a94884c07b2dbe979f59af594",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_log,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:history_log}",
                                "name": "Cantidad de d\u00edas en history_log menores a {$CTRLPART.DIASLEFT.HIGH:history_log}",
                                "priority": "HIGH",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES"
                            },
                            {
                                "uuid": "3da4b0c403ac480a83abcd127e5ca95d",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_log,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.WARNING:history_log}",
                                "name": "Cantidad de d\u00edas en history_log menores a {$CTRLPART.DIASLEFT.WARNING:history_log}",
                                "priority": "WARNING",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES",
                                "dependencies": [
                                    {
                                        "name": "Cantidad de d\u00edas en history_log menores a {$CTRLPART.DIASLEFT.HIGH:history_log}",
                                        "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_log,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:history_log}"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "uuid": "3944b7e62f724cfeb797fdad58e5c0a7",
                        "name": "Dias disponibles en history_str",
                        "type": "ODBC",
                        "key": "db.odbc.get[Dias que quedan para history_str,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}]",
                        "delay": "1d",
                        "params": "CALL partition_daysleft(\"{$CTRLPART.DB.NAME}\",\"history_str\")",
                        "username": "{$CTRLPART.DB.USER}",
                        "password": "{$CTRLPART.DB.PASSWORD}",
                        "description": "Cantidad de d\u00edas enteros disponibles para insertar en la tabla",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.[0].DaysLeft"
                                ]
                            },
                            {
                                "type": "REGEX",
                                "parameters": [
                                    "\\d+",
                                    "\\0"
                                ],
                                "error_handler": "CUSTOM_ERROR",
                                "error_handler_params": "La tabla no est\u00e1 particionada"
                            }
                        ],
                        "tags": [
                            {
                                "tag": "Application",
                                "value": "Control"
                            },
                            {
                                "tag": "Application",
                                "value": "Particionado"
                            }
                        ],
                        "triggers": [
                            {
                                "uuid": "0c9b330acf2740049734147d01a7199e",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_str,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:history_str}",
                                "name": "Cantidad de d\u00edas en history_str menores a {$CTRLPART.DIASLEFT.HIGH:history_str}",
                                "priority": "HIGH",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES"
                            },
                            {
                                "uuid": "167a9c77ded64b1687df944cc3305c15",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_str,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.WARNING:history_str}",
                                "name": "Cantidad de d\u00edas en history_str menores a {$CTRLPART.DIASLEFT.WARNING:history_str}",
                                "priority": "WARNING",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES",
                                "dependencies": [
                                    {
                                        "name": "Cantidad de d\u00edas en history_str menores a {$CTRLPART.DIASLEFT.HIGH:history_str}",
                                        "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_str,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:history_str}"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "uuid": "10b3391ed4074c3f804eb3241b0a24ea",
                        "name": "Dias disponibles en history_text",
                        "type": "ODBC",
                        "key": "db.odbc.get[Dias que quedan para history_text,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}]",
                        "delay": "1d",
                        "params": "CALL partition_daysleft(\"{$CTRLPART.DB.NAME}\",\"history_text\")",
                        "username": "{$CTRLPART.DB.USER}",
                        "password": "{$CTRLPART.DB.PASSWORD}",
                        "description": "Cantidad de d\u00edas enteros disponibles para insertar en la tabla",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.[0].DaysLeft"
                                ]
                            },
                            {
                                "type": "REGEX",
                                "parameters": [
                                    "\\d+",
                                    "\\0"
                                ],
                                "error_handler": "CUSTOM_ERROR",
                                "error_handler_params": "La tabla no est\u00e1 particionada"
                            }
                        ],
                        "tags": [
                            {
                                "tag": "Application",
                                "value": "Control"
                            },
                            {
                                "tag": "Application",
                                "value": "Particionado"
                            }
                        ],
                        "triggers": [
                            {
                                "uuid": "ea69db0f8c414ddb86b41235b1e182db",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_text,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:history_text}",
                                "name": "Cantidad de d\u00edas en history_text menores a {$CTRLPART.DIASLEFT.HIGH:history_text}",
                                "priority": "HIGH",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES"
                            },
                            {
                                "uuid": "42403c4fa826499ea2738078657b6cf3",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_text,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.WARNING:history_text}",
                                "name": "Cantidad de d\u00edas en history_text menores a {$CTRLPART.DIASLEFT.WARNING:history_text}",
                                "priority": "WARNING",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES",
                                "dependencies": [
                                    {
                                        "name": "Cantidad de d\u00edas en history_text menores a {$CTRLPART.DIASLEFT.HIGH:history_text}",
                                        "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_text,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:history_text}"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "uuid": "58982381152a4a539b5a8ada49ff2677",
                        "name": "Dias disponibles en history_uint",
                        "type": "ODBC",
                        "key": "db.odbc.get[Dias que quedan para history_uint,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}]",
                        "delay": "1d",
                        "params": "CALL partition_daysleft(\"{$CTRLPART.DB.NAME}\",\"history_uint\")",
                        "username": "{$CTRLPART.DB.USER}",
                        "password": "{$CTRLPART.DB.PASSWORD}",
                        "description": "Cantidad de d\u00edas enteros disponibles para insertar en la tabla",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.[0].DaysLeft"
                                ]
                            },
                            {
                                "type": "REGEX",
                                "parameters": [
                                    "\\d+",
                                    "\\0"
                                ],
                                "error_handler": "CUSTOM_ERROR",
                                "error_handler_params": "La tabla no est\u00e1 particionada"
                            }
                        ],
                        "tags": [
                            {
                                "tag": "Application",
                                "value": "Control"
                            },
                            {
                                "tag": "Application",
                                "value": "Particionado"
                            }
                        ],
                        "triggers": [
                            {
                                "uuid": "284e656ffb1e4979808f48de7b4dc6b7",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_uint,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:history_uint}",
                                "name": "Cantidad de d\u00edas en history_uint menores a {$CTRLPART.DIASLEFT.HIGH:history_uint}",
                                "priority": "HIGH",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES"
                            },
                            {
                                "uuid": "5f0763a7fd9e43bd8af0cb06884737eb",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_uint,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.WARNING:history_uint}",
                                "name": "Cantidad de d\u00edas en history_uint menores a {$CTRLPART.DIASLEFT.WARNING:history_uint}",
                                "priority": "WARNING",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES",
                                "dependencies": [
                                    {
                                        "name": "Cantidad de d\u00edas en history_uint menores a {$CTRLPART.DIASLEFT.HIGH:history_uint}",
                                        "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para history_uint,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:history_uint}"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "uuid": "3b8735d25a834068b89789d9480b575d",
                        "name": "Dias disponibles en trends",
                        "type": "ODBC",
                        "key": "db.odbc.get[Dias que quedan para trends,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}]",
                        "delay": "1d",
                        "params": "CALL partition_daysleft(\"{$CTRLPART.DB.NAME}\",\"trends\")",
                        "username": "{$CTRLPART.DB.USER}",
                        "password": "{$CTRLPART.DB.PASSWORD}",
                        "description": "Cantidad de d\u00edas enteros disponibles para insertar en la tabla",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.[0].DaysLeft"
                                ]
                            },
                            {
                                "type": "REGEX",
                                "parameters": [
                                    "\\d+",
                                    "\\0"
                                ],
                                "error_handler": "CUSTOM_ERROR",
                                "error_handler_params": "La tabla no est\u00e1 particionada"
                            }
                        ],
                        "tags": [
                            {
                                "tag": "Application",
                                "value": "Control"
                            },
                            {
                                "tag": "Application",
                                "value": "Particionado"
                            }
                        ],
                        "triggers": [
                            {
                                "uuid": "98bb8157330740ea95b860928fc4afe4",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para trends,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:trends}",
                                "name": "Cantidad de d\u00edas en trends menores a {$CTRLPART.DIASLEFT.HIGH:trends}",
                                "priority": "HIGH",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES"
                            },
                            {
                                "uuid": "7fabc3abcc5741a1912a16e29a9fdc3e",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para trends,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.WARNING:trends}",
                                "name": "Cantidad de d\u00edas en trends menores a {$CTRLPART.DIASLEFT.WARNING:trends}",
                                "priority": "WARNING",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES",
                                "dependencies": [
                                    {
                                        "name": "Cantidad de d\u00edas en trends menores a {$CTRLPART.DIASLEFT.HIGH:trends}",
                                        "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para trends,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:trends}"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "uuid": "7cb8fd0cb1634b80bb325595da68d988",
                        "name": "Dias disponibles en trends_uint",
                        "type": "ODBC",
                        "key": "db.odbc.get[Dias que quedan para trends_uint,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}]",
                        "delay": "1d",
                        "params": "CALL partition_daysleft(\"{$CTRLPART.DB.NAME}\",\"trends_uint\")",
                        "username": "{$CTRLPART.DB.USER}",
                        "password": "{$CTRLPART.DB.PASSWORD}",
                        "description": "Cantidad de d\u00edas enteros disponibles para insertar en la tabla",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.[0].DaysLeft"
                                ]
                            },
                            {
                                "type": "REGEX",
                                "parameters": [
                                    "\\d+",
                                    "\\0"
                                ],
                                "error_handler": "CUSTOM_ERROR",
                                "error_handler_params": "La tabla no est\u00e1 particionada"
                            }
                        ],
                        "tags": [
                            {
                                "tag": "Application",
                                "value": "Control"
                            },
                            {
                                "tag": "Application",
                                "value": "Particionado"
                            }
                        ],
                        "triggers": [
                            {
                                "uuid": "00852c94a0b7472d941aaf3c3b0d7259",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para trends_uint,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:trends_uint}",
                                "name": "Cantidad de d\u00edas en trends_uint menores a {$CTRLPART.DIASLEFT.HIGH:trends_uint}",
                                "priority": "HIGH",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES"
                            },
                            {
                                "uuid": "6254d63df08647f79387dda801b3ec2d",
                                "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para trends_uint,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.WARNING:trends_uint}",
                                "name": "Cantidad de d\u00edas en trends_uint menores a {$CTRLPART.DIASLEFT.WARNING:trends_uint}",
                                "priority": "WARNING",
                                "description": "Quedan pocos d\u00edas disponibles para insertar en la tabla",
                                "manual_close": "YES",
                                "dependencies": [
                                    {
                                        "name": "Cantidad de d\u00edas en trends_uint menores a {$CTRLPART.DIASLEFT.HIGH:trends_uint}",
                                        "expression": "last(/Control Particionado MySQL - ODBC Custos/db.odbc.get[Dias que quedan para trends_uint,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}])<{$CTRLPART.DIASLEFT.HIGH:trends_uint}"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "uuid": "5a8678d0fe4c4e96bd6cf74256455d1c",
                        "name": "Ejecuci\u00f3n Mantenimiento Particionado ODBC",
                        "type": "ODBC",
                        "key": "db.odbc.get[Ejecucion Particionado ODBC,{$CTRLPART.DB.DSN},{$CTRLPART.DB.CONSTR}]",
                        "delay": "1d",
                        "history": "1w",
                        "trends": "0",
                        "value_type": "TEXT",
                        "params": "CALL partition_maintenance_all(\"{$CTRLPART.DB.NAME}\");",
                        "username": "{$CTRLPART.DB.USER}",
                        "password": "{$CTRLPART.DB.PASSWORD}",
                        "description": "Ejecuta el stored procedure que mantiene las particiones en la DB de Zabbix",
                        "tags": [
                            {
                                "tag": "Application",
                                "value": "Ejecucion"
                            },
                            {
                                "tag": "Application",
                                "value": "Particionado"
                            }
                        ]
                    },
                    {
                        "uuid": "3ffcd26a73d84ff5a87e8e81bfe9c89e",
                        "name": "Creaci\u00f3n de Stored procedures",
                        "type": "SSH",
                        "key": "ssh.run[mysql create stored procedures,{$CTRLPART.SSH.HOST},{$CTRLPART.SSH.PORT}]",
                        "delay": "0;md31wd1h0m0s0",
                        "trends": "0",
                        "status": "DISABLED",
                        "value_type": "TEXT",
                        "params": "echo 'DELIMITER |\ndrop PROCEDURE if exists partition_daysleft |\nCREATE PROCEDURE `partition_daysleft`(SCHEMANAME varchar(64), TABLENAME varchar(64))\nBEGIN\n   DECLARE UltDia int;\n   SELECT PARTITION_DESCRIPTION INTO UltDia\n     FROM information_schema.partitions\n     WHERE table_schema = SCHEMANAME\n       and table_name = TABLENAME\n     order by PARTITION_DESCRIPTION desc limit 1;\n   SELECT datediff( From_Unixtime(UltDia) , Now() ) AS \"DaysLeft\";\nEND |\ndrop PROCEDURE if exists partition_create |\nCREATE PROCEDURE `partition_create`(SCHEMANAME varchar(64), TABLENAME varchar(64), PARTITIONNAME varchar(64), CLOCK int)\nBEGIN\n   DECLARE RETROWS INT;\n   SELECT COUNT(1) INTO RETROWS\n      FROM information_schema.partitions\n      WHERE table_schema = SCHEMANAME\n        AND table_name = TABLENAME\n        AND partition_description >= CLOCK;\n\n   IF RETROWS = 0 THEN\n      insert into logint values ( SCHEMANAME, TABLENAME, \"CREATE PARTITION\", PARTITIONNAME);\n      SET @sql = CONCAT( \"ALTER TABLE \", SCHEMANAME, \".\", TABLENAME, \" ADD PARTITION (PARTITION \",\n                          PARTITIONNAME, \" VALUES LESS THAN (\", CLOCK, \"));\" );\n      PREPARE STMT FROM @sql;\n      EXECUTE STMT;\n      DEALLOCATE PREPARE STMT;\n   ELSE\n      insert into logint values ( SCHEMANAME, TABLENAME, \"CREATE PARTITION\", \"N/A\");\n   END IF;\nEND |\ndrop PROCEDURE if exists partition_drop |\nCREATE PROCEDURE `partition_drop`(SCHEMANAME VARCHAR(64), TABLENAME VARCHAR(64), DELETE_BELOW_PARTITION_DATE BIGINT)\nBEGIN\n   DECLARE done INT DEFAULT FALSE;\n   DECLARE drop_part_name VARCHAR(16);\n   \n   DECLARE myCursor CURSOR FOR\n   SELECT partition_name\n      FROM information_schema.partitions\n      WHERE table_schema = SCHEMANAME\n        AND table_name = TABLENAME\n        AND CAST(SUBSTRING(partition_name FROM 2) AS UNSIGNED) < DELETE_BELOW_PARTITION_DATE;\n   DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;\n\n   SET @alter_header = CONCAT(\"ALTER TABLE \", SCHEMANAME, \".\", TABLENAME, \" DROP PARTITION \");\n   SET @drop_partitions = \"\";\n   \n   OPEN myCursor;\n   read_loop: LOOP\n      FETCH myCursor INTO drop_part_name;\n      IF done THEN\n         LEAVE read_loop;\n      END IF;\n      SET @drop_partitions = IF(@drop_partitions = \"\", drop_part_name, CONCAT(@drop_partitions, \",\", drop_part_name));\n   END LOOP;\n   IF @drop_partitions != \"\" THEN\n      SET @full_sql = CONCAT(@alter_header, @drop_partitions, \";\");\n      PREPARE STMT FROM @full_sql;\n      EXECUTE STMT;\n      DEALLOCATE PREPARE STMT;\n\n      insert into logint values ( SCHEMANAME, TABLENAME, \" DROP PARTITION \", @drop_partitions);\n   ELSE\n      insert into logint values ( SCHEMANAME, TABLENAME, \" DROP PARTITION \", \"N/A\");\n   END IF;\nEND |\ndrop PROCEDURE if exists partition_maintenance |\nCREATE PROCEDURE `partition_maintenance`(SCHEMA_NAME VARCHAR(32), TABLE_NAME VARCHAR(32), KEEP_DATA_DAYS INT, HOURLY_INTERVAL INT, CREATE_NEXT_INTERVALS INT)\nBEGIN\n   DECLARE OLDER_THAN_PARTITION_DATE VARCHAR(16);\n   DECLARE PARTITION_NAME VARCHAR(16);\n   DECLARE OLD_PARTITION_NAME VARCHAR(16);\n   DECLARE LESS_THAN_TIMESTAMP INT;\n   DECLARE CUR_TIME INT;\n\n   CALL partition_verify(SCHEMA_NAME, TABLE_NAME, HOURLY_INTERVAL);\n   SET CUR_TIME = UNIX_TIMESTAMP(DATE_FORMAT(NOW(), \"%Y-%m-%d 00:00:00\"));\n\n   SET @__interval = 1;\n   create_loop: LOOP\n      IF @__interval > CREATE_NEXT_INTERVALS THEN\n         LEAVE create_loop;\n      END IF;\n\n      SET LESS_THAN_TIMESTAMP = CUR_TIME + (HOURLY_INTERVAL * @__interval * 3600);\n      SET PARTITION_NAME = FROM_UNIXTIME(CUR_TIME + HOURLY_INTERVAL * (@__interval - 1) * 3600, \"p%Y%m%d%H00\");\n      IF(PARTITION_NAME != OLD_PARTITION_NAME) THEN\n          CALL partition_create(SCHEMA_NAME, TABLE_NAME, PARTITION_NAME, LESS_THAN_TIMESTAMP);\n      END IF;\n      SET @__interval=@__interval+1;\n      SET OLD_PARTITION_NAME = PARTITION_NAME;\n   END LOOP;\n\n   SET OLDER_THAN_PARTITION_DATE=DATE_FORMAT(DATE_SUB(NOW(), INTERVAL KEEP_DATA_DAYS DAY), \"%Y%m%d0000\");\n   CALL partition_drop(SCHEMA_NAME, TABLE_NAME, OLDER_THAN_PARTITION_DATE);\nEND |\ndrop PROCEDURE if exists partition_maintenance_all |\nCREATE PROCEDURE `partition_maintenance_all`(SCHEMA_NAME VARCHAR(32))\nBEGIN\n   CREATE TEMPORARY TABLE logint(schemaname varchar(255), tablename varchar(255), action varchar(255), partitionname varchar(255));\n\n   CALL partition_maintenance(SCHEMA_NAME, \"history\",      {$CTRLPART.HISTORY.KEEPINT:history},      {$CTRLPART.HISTORY.HOURSINT:history},     {$CTRLPART.HISTORY.NEXTINT:history}   );\n   CALL partition_maintenance(SCHEMA_NAME, \"history_log\",  {$CTRLPART.HISTORY.KEEPINT:history_log},  {$CTRLPART.HISTORY.HOURSINT:history},     {$CTRLPART.HISTORY.NEXTINT:history}   );\n   CALL partition_maintenance(SCHEMA_NAME, \"history_str\",  {$CTRLPART.HISTORY.KEEPINT:history_str},  {$CTRLPART.HISTORY.HOURSINT:history},     {$CTRLPART.HISTORY.NEXTINT:history}   );\n   CALL partition_maintenance(SCHEMA_NAME, \"history_text\", {$CTRLPART.HISTORY.KEEPINT:history_text}, {$CTRLPART.HISTORY.HOURSINT:history},     {$CTRLPART.HISTORY.NEXTINT:history}   );\n   CALL partition_maintenance(SCHEMA_NAME, \"history_uint\", {$CTRLPART.HISTORY.KEEPINT:history_uint}, {$CTRLPART.HISTORY.HOURSINT:history},     {$CTRLPART.HISTORY.NEXTINT:history}   );\n   CALL partition_maintenance(SCHEMA_NAME, \"trends\",       {$CTRLPART.TRENDS.KEEPINT:trends},        {$CTRLPART.TRENDS.HOURSINT:trends},       {$CTRLPART.TRENDS.NEXTINT:trends}     );\n   CALL partition_maintenance(SCHEMA_NAME, \"trends_uint\",  {$CTRLPART.TRENDS.KEEPINT:trends_uint},   {$CTRLPART.TRENDS.HOURSINT:trends_uint},  {$CTRLPART.TRENDS.NEXTINT:trends_uint});\n\n   SELECT distinct * from logint;\nEND |\ndrop PROCEDURE if exists partition_verify |\nCREATE PROCEDURE `partition_verify`(SCHEMANAME VARCHAR(64), TABLENAME VARCHAR(64), HOURLYINTERVAL INT(11))\nBEGIN\n   DECLARE PARTITION_NAME VARCHAR(16);\n   DECLARE RETROWS INT(11);\n   DECLARE FUTURE_TIMESTAMP TIMESTAMP;\n\n   SELECT COUNT(1) INTO RETROWS\n      FROM information_schema.partitions\n      WHERE table_schema = SCHEMANAME\n        AND table_name = TABLENAME\n        AND partition_name IS NULL;\n\n   IF RETROWS = 1 THEN\n      SET FUTURE_TIMESTAMP = TIMESTAMPADD(HOUR, HOURLYINTERVAL, CONCAT(CURDATE(), \" \", \"00:00:00\"));\n      SET PARTITION_NAME = DATE_FORMAT(CURDATE(), \"p%Y%m%d%H00\");\n\n      SET @__PARTITION_SQL = CONCAT(\"ALTER TABLE \", SCHEMANAME, \".\", TABLENAME, \" PARTITION BY RANGE(`clock`)\");\n      SET @__PARTITION_SQL = CONCAT(@__PARTITION_SQL, \"(PARTITION \", PARTITION_NAME,\n                                     \" VALUES LESS THAN (\", UNIX_TIMESTAMP(FUTURE_TIMESTAMP), \"));\");\n      \n      PREPARE STMT FROM @__PARTITION_SQL;\n      EXECUTE STMT;\n      DEALLOCATE PREPARE STMT;\n   END IF;\nEND |' | mysql -h {$CTRLPART.DB.HOST} -P {$CTRLPART.DB.PORT} -u {$CTRLPART.DB.USER} -p{$CTRLPART.DB.PASSWORD} {$CTRLPART.DB.NAME} -v",
                        "username": "{$CTRLPART.SSH.USER}",
                        "password": "{$CTRLPART.SSH.PASSWORD}",
                        "description": "Crea los stored prodedures para el mantenimiento del particionado.",
                        "preprocessing": [
                            {
                                "type": "JAVASCRIPT",
                                "parameters": [
                                    "if (value.length==0){\n return \"No hay datos\"\n}\n\nres = value.match(/CREATE PROCEDURE `(.*)`/g)\nerror=\"\"\n\nfunction contains(a, obj) {\n    var i = a.length;\n    while (i--) {\n       if (a[i] == obj) {\n           return true;\n       }\n    }\n    return false;\n}\n\nfunction ExPr(pr,resultado){\n if (!contains(resultado,\"CREATE PROCEDURE `\"+pr+\"`\")) {\n  if (error.length == 0) {\n    error=pr\n  } else {\n    error=error+\", \"+pr\n  }\n }\n}\n\nExPr(\"partition_daysleft\",res)\nExPr(\"partition_create\",res)\nExPr(\"partition_drop\",res)\nExPr(\"partition_maintenance\",res)\nExPr(\"partition_maintenance_all\",res)\nExPr(\"partition_verify\",res)\n\nif (error.length==0){\n error=\"OK\"\n} else {\n error=\"Faltaron crear: \"+error\n}\n\nreturn error"
                                ]
                            }
                        ],
                        "tags": [
                            {
                                "tag": "Application",
                                "value": "Control"
                            },
                            {
                                "tag": "Application",
                                "value": "Particionado"
                            }
                        ]
                    }
                ],
                "tags": [
                    {
                        "tag": "alcance",
                        "value": "particionado"
                    },
                    {
                        "tag": "aplicacion",
                        "value": "basededatos"
                    }
                ],
                "macros": [
                    {
                        "macro": "{$CTRLPART.DB.CONSTR}",
                        "value": "Driver=/usr/lib64/libmaodbc.so;Server=localhost;Port=3306;Database=zabbix",
                        "description": "Conection String a la DB"
                    },
                    {
                        "macro": "{$CTRLPART.DB.DSN}",
                        "description": "Nombre del DSN para conectarse"
                    },
                    {
                        "macro": "{$CTRLPART.DB.HOST}",
                        "value": "localhost",
                        "description": "Host donde se encuentra la DB para la creaci\u00f3n de los stored procedures"
                    },
                    {
                        "macro": "{$CTRLPART.DB.NAME}",
                        "value": "zabbix",
                        "description": "Nombre de la base de datos en donde se mantienen las particiones"
                    },
                    {
                        "macro": "{$CTRLPART.DB.PASSWORD}",
                        "description": "Password del usuario en la DB"
                    },
                    {
                        "macro": "{$CTRLPART.DB.PORT}",
                        "value": "3306",
                        "description": "Puerto para la conexi\u00f3n a la DB"
                    },
                    {
                        "macro": "{$CTRLPART.DB.USER}",
                        "description": "Usuario para conectarse a la DB"
                    },
                    {
                        "macro": "{$CTRLPART.DIASLEFT.HIGH}",
                        "value": "2",
                        "description": "Dias limite para alarma HIGH"
                    },
                    {
                        "macro": "{$CTRLPART.DIASLEFT.WARNING}",
                        "value": "7",
                        "description": "Dias limite alarma de WARNING"
                    },
                    {
                        "macro": "{$CTRLPART.HISTORY.HOURSINT}",
                        "value": "24",
                        "description": "Horas de intervalo de las tablas de history.  Acepta contexto con el nombre de la tabla"
                    },
                    {
                        "macro": "{$CTRLPART.HISTORY.KEEPINT}",
                        "value": "30",
                        "description": "Intervalos a conservar en las tablas de history. Acepta contexto con el nombre de la tabla"
                    },
                    {
                        "macro": "{$CTRLPART.HISTORY.NEXTINT}",
                        "value": "10",
                        "description": "Cantidad  de particiones a futuro para las tablas de history.  Acepta contexto con el nombre de la tabla"
                    },
                    {
                        "macro": "{$CTRLPART.SSH.HOST}",
                        "value": "127.0.0.1",
                        "description": "Host donde se encuentra la DB para conexi\u00f3n por SSH"
                    },
                    {
                        "macro": "{$CTRLPART.SSH.PASSWORD}",
                        "description": "Password donde se encuentra la DB para conexi\u00f3n por SSH"
                    },
                    {
                        "macro": "{$CTRLPART.SSH.PORT}",
                        "value": "22",
                        "description": "Puerto para conexi\u00f3n SSH al Host DB"
                    },
                    {
                        "macro": "{$CTRLPART.SSH.USER}",
                        "description": "User donde se encuentra la DB para conexi\u00f3n por SSH"
                    },
                    {
                        "macro": "{$CTRLPART.TRENDS.HOURSINT}",
                        "value": "24",
                        "description": "Horas de intervalo de las tablas de trends.  Acepta contexto con el nombre de la tabla"
                    },
                    {
                        "macro": "{$CTRLPART.TRENDS.KEEPINT}",
                        "value": "365",
                        "description": "Intervalos a conservar en las tablas de trends. Acepta contexto con el nombre de la tabla"
                    },
                    {
                        "macro": "{$CTRLPART.TRENDS.NEXTINT}",
                        "value": "10",
                        "description": "Cantidad de particiones a futuro para las tablas de trends.  Acepta contexto con el nombre de la tabla"
                    }
                ]
            }
        ]
    }
}
